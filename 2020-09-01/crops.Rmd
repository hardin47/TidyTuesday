---
title: "Global Crop Yield"
author: "Jo Hardin"
date: "9/1/2020"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)
library(infer)
library(broom)
library(openintro)
library(kableExtra)
set.seed(4747)
```


For a different project, I'm in need of a dataset to use to work through some inferential linear model ideas.  Seems like maybe the crop yield dataset could be used?

Not sure how easy it is to create an inferential claim, but I'm going to try!

## The Data


```{r}
fertilizer <- readr::read_csv('cereal_crop_yield_vs_fertilizer_application.csv')
tractors <- readr::read_csv('cereal_yields_vs_tractor_inputs_in_agriculture.csv')
land_use <- readr::read_csv('land_use_vs_yield_change_in_cereal_production.csv')
arable_land <- readr::read_csv('arable_land_pin.csv')

key_crop_yields <- readr::read_csv('key_crop_yields.csv') %>%
  rename(wheat = `Wheat (tonnes per hectare)`,
         rice = `Rice (tonnes per hectare)`,
         maize = `Maize (tonnes per hectare)`,
         soybeans = `Soybeans (tonnes per hectare)`,
         potatoes = `Potatoes (tonnes per hectare)`,
         beans = `Beans (tonnes per hectare)`,
         peas = `Peas (tonnes per hectare)`,
         cassava = `Cassava (tonnes per hectare)`,
         barley = `Barley (tonnes per hectare)`,
         cocoa = `Cocoa beans (tonnes per hectare)`,
         bananas = `Bananas (tonnes per hectare)`)
  
crops_USA <- key_crop_yields %>%
  filter(Code == "USA")
```



## Goals for inference in linear regression:

* make inferential claims about the model
* create confidence intervals for the slope


##  EDA

```{r}
ggplot(crops_USA) +
  geom_point(aes(x = peas, y = wheat, color = Year)) +
  geom_smooth(aes(x = peas, y = wheat), method = "lm", se = FALSE, color = COL[1,1]) 
```


```{r}
ggplot(crops_USA) +
  geom_point(aes(x = maize, y = wheat)) +
  geom_smooth(aes(x = maize, y = wheat), method = "lm", se = FALSE, color = COL[1,1]) 
```

The code below is trying to find crops that have natural positive and negative correlations.  Generally, yield is a function of population size, so I found the percent of a particular crop over all crop yield (summed over time) for a given country.  Also, I filtered out countries that didn't have data for most of the crops.

```{r}
library(ggpubr)
library(naniar)

mw <- ggplot(crops_USA) +
  geom_point(aes(x = maize, y = wheat))


crops_country <- key_crop_yields %>%
  filter(!is.na(Code)) %>%  # remove continents, etc.
  group_by(Code) %>%  # to sum and percent by country
  summarize(swheat = sum(wheat, na.rm = TRUE),
            srice = sum(rice, na.rm = TRUE),
            smaize = sum(maize, na.rm = TRUE),
            ssoybeans = sum(soybeans, na.rm = TRUE),
            spotatoes = sum(potatoes, na.rm = TRUE),
            sbeans = sum(beans, na.rm = TRUE),
            speas = sum(peas, na.rm = TRUE),
            scassava = sum(cassava, na.rm = TRUE),
            sbarley = sum(barley, na.rm = TRUE),
            scocoa = sum(cocoa, na.rm = TRUE),
            sbananas = sum(bananas, na.rm = TRUE),
            pwheat = 100*swheat / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            price = 100*srice / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            pmaize = 100*smaize / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            psoybeans = 100*ssoybeans / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            ppotatoes = 100*spotatoes / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            pbeans = 100*sbeans / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            ppeas = 100*speas / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            pcassava = 100*scassava / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            pbarley = 100*sbarley / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            pcocoa = 100*scocoa / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            pbananas = 100*sbananas / (swheat + srice + smaize + ssoybeans + spotatoes + sbeans + speas + scassava + sbarley + scocoa + sbananas),
            ) %>%
  replace_with_na_all(condition = ~.x == 0)%>%
  mutate(nmiss = rowSums(is.na(.))/2) %>%
  filter(nmiss <= 5)  # filter out countries that don't have data for most of the crops.
      
            
sb <- ggplot(crops_country) +
  geom_point(aes(x = psoybeans, y = pbananas)) +
  xlim(c(0,6)) + 
  xlab("% soybeans") +
  ylab("% bananas")

sc <- ggplot(crops_country) +
  geom_point(aes(x = psoybeans, y = pcassava)) +
  xlim(c(0,6)) + 
  xlab("% soybeans") +
  ylab("% cassava")

mc <- ggplot(crops_country) +
  geom_point(aes(x = pmaize, y = pcassava)) +
  xlim(c(0,15)) + 
  xlab("% maize") +
  ylab("% cassava")

peb <- ggplot(crops_country) +
  geom_point(aes(x = ppotatoes, y = pbananas)) +
  xlim(c(0,60)) + 
  xlab("% potatoes") +
  ylab("% bananas")

cb <- ggplot(crops_country) +
  geom_point(aes(x = pcocoa, y = pbananas)) +
  xlab("% cocoa") +
  ylab("% bananas")

wb <- ggplot(crops_country) +
  geom_point(aes(x = pwheat, y = pbarley)) +
  xlab("% wheat") +
  ylab("% barley")

pob <- ggplot(crops_country) +
  geom_point(aes(x = ppeas, y = pbarley)) +
  xlab("% peas") +
  ylab("% barley")

ggpubr::ggarrange( peb, sc, mc, cb, pob, wb, 
                   labels = c("A", "B", "C", "D", "E", "F"),
                   ncol = 3, nrow = 2)

```


```{r}
temptbl <- tribble(
 ~variable,  ~col1, ~col2, ~corval,
 "A", "potatoes", "bananas", round(cor(crops_country$ppotatoes, crops_country$pbananas, use = "pairwise.complete.obs"), digits = 2),
 "B", "soybeans", "cassava", round(cor(crops_country$psoybeans, crops_country$pcassava, use = "pairwise.complete.obs"), digits = 2),
 "C", "maize", "cassava", round(cor(crops_country$pmaize, crops_country$pcassava, use = "pairwise.complete.obs"), digits = 2),
 "D", "cocoa", "bananas", round(cor(crops_country$pcocoa, crops_country$pbananas, use = "pairwise.complete.obs"), digits = 2),
 "E", "peas", "barley", round(cor(crops_country$ppeas, crops_country$pbarley, use = "pairwise.complete.obs"), digits = 2),
 "F", "wheat", "barley", round(cor(crops_country$pwheat, crops_country$pbarley, use = "pairwise.complete.obs"), digits = 2),
)

temptbl %>%
 kable(caption = "Correlation of percentage of total yield across different crops.",
  col.names = c("Graph", "x-variable", "y-variable", "correlation")) %>%
 kable_styling() 
```

```{r}
library(GGally)
ggpairs(crops_country[,13:23])

temp <- cor(crops_country[,13:23], use = "pairwise.complete.obs")
diag(temp) <- NA
temp %>%
  quantile(na.rm = TRUE)

temp
```





## SLR

```{r}
crops_USA %>%
  lm(wheat ~ peas, .) %>%
  tidy()
```



```{r}
crops_USA %>%
  lm(wheat ~ maize, .) %>%
  tidy()
```


## Sampling distribution


```{r}
set.seed(4747)
crops2 <- crops_USA %>% 
  sample_n(size=20) 
crops3 <- crops_USA %>%
  sample_n(size=20)
crops_many <- crops_USA %>%
  rep_sample_n(size = 20, replace = FALSE, reps = 50)
```


```{r}
ggplot(crops_USA) +
  geom_point(aes(x = maize, y = wheat)) +
  geom_smooth(aes(x = maize, y = wheat), method = "lm", se = FALSE, color = COL[1,1]) 
```


A subset of size 20 items shows a similar positive trend between maize and wheat, despite having fewer observations on the plot.


```{r echo = FALSE}
ggplot(crops2) +
  geom_point(aes(x = maize, y = wheat)) +
  geom_smooth(aes(x = maize, y = wheat), method = "lm", se = FALSE, color = COL[1,1]) 
```


A second sample of size 20 also shows a positive trend!

```{r echo = FALSE}
ggplot(crops3) +
  geom_point(aes(x = maize, y = wheat)) +
  geom_smooth(aes(x = maize, y = wheat), method = "lm", se = FALSE, color = COL[4,1]) 
```


But the line is slightly different!

```{r echo = FALSE}
ggplot(crops2, aes(x = maize, y = wheat)) + geom_point(color="#569BBD") + 
  geom_smooth(method="lm", se=FALSE, color="#569BBD") + 
  geom_point(data=crops3, color="#F05133") +
  geom_smooth(data=crops3, method="lm", se=FALSE, color="#F05133")
```


That is, there is variability in the regression line from sample to sample.  The concept of the sampling variability is something you've seen before, but in this lesson, you will focus on the variability of the line instead of the variability of a single statistic.

```{r echo = FALSE}
ggplot(crops_many, aes(x=maize, y=wheat, group=replicate)) + 
  geom_point() + 
  ggtitle("maize vs. wheat for annual crop yield in the US (n=20)") + 
  geom_smooth(method="lm", se=FALSE, color = COL[1,1])
```  


```{r echo = FALSE}
crops_many_lm <- crops_many %>% 
  group_by(replicate) %>% 
  do(tidy(lm(wheat ~ maize, data=.))) %>%
  filter(term=="maize")

ggplot(crops_many_lm, aes(x=estimate)) + geom_histogram()
```

